name: Auto-Download Config Folder from BisectHosting SFTP

on:
  schedule:
    - cron: '0 4 * * *'           # Runs daily at 04:00 UTC
  workflow_dispatch:              # Allows manual triggering from the Actions tab

jobs:
  download-config:
    runs-on: ubuntu-latest
    timeout-minutes: 15           # Safety timeout for the whole job

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # Needed for proper git commit history

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Download config folder via SFTP
        env:
            SFTP_HOST: ${{ secrets.BISECT_SFTP_HOST }}
            SFTP_PORT: ${{ secrets.BISECT_SFTP_PORT || '22' }}
            SFTP_USER: ${{ secrets.BISECT_SFTP_USERNAME }}
            SFTP_PASS: ${{ secrets.BISECT_SFTP_PASSWORD }}
        run: |
          set -euxo pipefail

          echo "▶ Creating local directory"
          mkdir -p downloaded-config

          echo "▶ Starting lftp session"
          lftp -d <<EOF
            set sftp:connect-program "ssh -a -x -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
            set net:timeout 15
            set net:max-retries 2
            set net:reconnect-interval-base 3
            set sftp:auto-confirm yes

            open -u "$SFTP_USER","$SFTP_PASS" sftp://"$SFTP_HOST":"$SFTP_PORT"

            ls -la

            cls -la config
            mirror --verbose --parallel=2 --timeout=30 config downloaded-config

            quit
            EOF
          echo "▶ lftp finished"
          echo "▶ Downloaded files:"
          ls -laR downloaded-config || true

      - name: Commit downloaded config files (if any changes)
        run: |
          git config --global user.name  "GitHub Action Bot"
          git config --global user.email "actions@github.com"

          git add downloaded-config/ || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Automated download of config folder from BisectHosting - $(date +'%Y-%m-%d %H:%M UTC')"
            git push origin HEAD:${{ github.ref_name }} || echo "Push failed or no upstream changes"
          fi