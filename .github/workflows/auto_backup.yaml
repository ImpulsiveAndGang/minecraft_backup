name: Auto-Download Minecraft Files from BisectHosting SFTP

on:
  schedule:
    - cron: '0 4 * * *'          # Daily at 04:00 UTC â€“ change to your preferred time
  workflow_dispatch:             # Allows manual trigger from GitHub Actions tab

jobs:
  download-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0           # Full history needed for committing changes

      - name: Install lftp (usually pre-installed, but ensure)
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Download files from Bisect SFTP using lftp mirror
        env:
          SFTP_HOST: ${{ secrets.BISECT_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.BISECT_SFTP_PORT || '22' }}
          SFTP_USER: ${{ secrets.BISECT_SFTP_USERNAME }}
          SFTP_PASS: ${{ secrets.BISECT_SFTP_PASSWORD || '' }}
        run: |
          mkdir -p downloaded-world downloaded-plugins downloaded-config

          lftp -u "$SFTP_USER,$SFTP_PASS" sftp://"$SFTP_HOST":"$SFTP_PORT" <<EOF
          set sftp:auto-confirm yes
          set net:timeout 30
          set net:max-retries 3
          set net:reconnect-interval-base 5

          # Mirror world folder (core Minecraft save data)
          # mirror --verbose --parallel=4 world/ ./downloaded-world/

          # Optional: mirror plugins and config folders (uncomment if needed)
          # mirror --verbose --parallel=4 plugins/ ./downloaded-plugins/
          mirror --verbose --parallel=4 config/ ./downloaded-config/

          quit
          EOF

      - name: Commit and push downloaded files to repo
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"

          git add downloaded-world/ downloaded-plugins/ downloaded-config/ || true
          git commit -m "Automated SFTP download from BisectHosting - $(date +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit (files unchanged)"
          git push origin HEAD:${{ github.ref_name }} || echo "Push failed or no changes"