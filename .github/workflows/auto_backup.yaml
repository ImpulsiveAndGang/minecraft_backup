name: Auto-Download Minecraft Files from BisectHosting SFTP

on:
  schedule:
    - cron: '0 4 * * *'          # Daily at 04:00 UTC â€“ adjust as needed
  workflow_dispatch:             # Manual trigger

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 30          # Overall job timeout in case of major hang

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Download files from Bisect SFTP (with debug & anti-hang settings)
        env:
          SFTP_HOST: ${{ secrets.BISECT_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.BISECT_SFTP_PORT || '2022' }}
          SFTP_USER: ${{ secrets.BISECT_SFTP_USERNAME }}
          SFTP_PASS: ${{ secrets.BISECT_SFTP_PASSWORD }}
        run: |
          mkdir -p downloaded-world

          # Use timeout command to kill if stuck >10 min
          timeout 600 lftp -v -v -c <<EOF || echo "lftp timed out or failed - check full logs"
          set sftp:connect-program "ssh -a -x -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          set net:timeout 15
          set net:max-retries 2
          set net:reconnect-interval-base 3
          set sftp:auto-confirm yes

          open -u "$SFTP_USER","$SFTP_PASS" sftp://"$SFTP_HOST":"$SFTP_PORT"

          # Test basic connection first
          ls

          # Mirror with debug; add --dry-run to test without downloading
          mirror --verbose --parallel=2 --timeout=30 --use-cache=no world/ ./downloaded-world/

          quit
          EOF

          echo "lftp exit code: $?"
          ls -la downloaded-world/   # Show if anything was actually downloaded

      - name: Commit and push if files were downloaded
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git add downloaded-world/ || true
          git commit -m "Automated SFTP download attempt - $(date +'%Y-%m-%d %H:%M UTC')" || echo "No changes"
          git push origin HEAD:${{ github.ref_name }} || echo "Push skipped"